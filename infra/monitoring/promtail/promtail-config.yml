# ═══════════════════════════════════════════════════════════════════════════════
# Promtail Configuration - Manchengo Smart ERP
# ═══════════════════════════════════════════════════════════════════════════════

server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  # ─── Docker Container Logs ──────────────────────────────────────────────────
  - job_name: containers
    static_configs:
      - targets:
          - localhost
        labels:
          job: docker
          __path__: /var/lib/docker/containers/*/*-json.log

    pipeline_stages:
      - json:
          expressions:
            output: log
            stream: stream
            timestamp: time

      - timestamp:
          source: timestamp
          format: RFC3339Nano

      - output:
          source: output

      # Extract container name from path
      - regex:
          source: filename
          expression: '/var/lib/docker/containers/(?P<container_id>[^/]+)/.*'

      - labels:
          container_id:

      # Filter for Manchengo containers
      - match:
          selector: '{job="docker"}'
          stages:
            - docker: {}

  # ─── Backend API Logs ───────────────────────────────────────────────────────
  - job_name: manchengo-backend
    static_configs:
      - targets:
          - localhost
        labels:
          job: manchengo-backend
          __path__: /var/log/manchengo/*.log

    pipeline_stages:
      # Parse JSON logs from Pino
      - json:
          expressions:
            level: level
            msg: msg
            time: time
            requestId: requestId
            correlationId: correlationId
            userId: userId
            module: module

      - labels:
          level:
          module:
          requestId:

      - timestamp:
          source: time
          format: Unix

      # Map Pino levels to Loki levels
      - template:
          source: level
          template: |
            {{ if eq .level "10" }}trace{{ else if eq .level "20" }}debug{{ else if eq .level "30" }}info{{ else if eq .level "40" }}warn{{ else if eq .level "50" }}error{{ else if eq .level "60" }}fatal{{ else }}unknown{{ end }}

      - labels:
          level:

  # ─── System Logs ────────────────────────────────────────────────────────────
  - job_name: system
    static_configs:
      - targets:
          - localhost
        labels:
          job: system
          __path__: /var/log/syslog

    pipeline_stages:
      - regex:
          expression: '^(?P<timestamp>\w+\s+\d+\s+\d+:\d+:\d+)\s+(?P<host>\S+)\s+(?P<process>[^:]+):\s+(?P<message>.*)$'

      - labels:
          host:
          process:

      - timestamp:
          source: timestamp
          format: 'Jan _2 15:04:05'
